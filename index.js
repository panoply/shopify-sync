"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("fancy-log")),a=e(require("chalk")),r=e(require("lodash/isNull")),n=e(require("lodash/first")),i=e(require("lodash/isUndefined")),s=e(require("lodash/isArray")),o=e(require("lodash/lastIndexOf")),l=e(require("lodash/drop")),d=require("path"),c=e(d),g=e(require("glob")),u=e(require("anymatch")),m=e(require("lodash/omit")),h=require("fs-extra"),p=e(require("lodash/has")),y=e(require("bluebird")),f=e(require("axios")),w=e(require("lodash/indexOf")),$=e(require("lodash/map")),b=e(require("lodash/find")),j=e(require("inquirer")),q=e(require("console-clear")),k=e(require("log-update")),v=e(require("boxen")),_=e(require("chokidar")),E=require("buffer");const S=e=>new Promise(t=>setTimeout(t,e)),O=async(e,t)=>{for(let a=0;a<e.length;a++)await t(e[a],a,e)},x=({api_key:e,password:t,domain:a})=>`https://${e}:${t}@${a}.myshopify.com`,F=(e,r="white",n=!1,i=("object"==typeof e?a[r]([(null==e?void 0:e.message)?e.message+"\n\n\t":"",(null==e?void 0:e.data)?JSON.stringify(e.data.asset?m(e.data.asset,"attachment"):e.data):""].join("")):e))=>n?console.log(i):t(i),I={};function B(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function T(e,t){var a=t.get(e);if(!a)throw new TypeError("attempted to get private field on non-instance");return a.get?a.get.call(e):a.value}let P=0,C=0,A=40,N=!1;class R{constructor(){U.set(this,{writable:!0,value:[]}),B(this,"process",async()=>{N=!0;do{let e=A-(C+P);e<=0&&(e=0);let t=e*e;t<=.9&&(t=.9);const a=500/t,r=T(this,U).shift();await y.delay(a),this.request(r)}while(T(this,U).length>0);N=!1}),B(this,"request",async({target:e,request:t,reject:a,resolve:r})=>{let n,i=null;P+=1;try{const a=Object.assign({},t,{url:`${x(e)}${t.url}`});i=await f(a)}catch(n){return"Too Many Requests"===n.statusText?(F("Exceeded Shopify API limit, will retry...","yellow"),T(this,U).unshift({target:e,request:t,resolve:r,reject:a})):a(this.handleErrors(t,n))}if(P-=1,await r(i.data),i.data.errors)return a(i.data.errors);n=i.headers["x-shopify-shop-api-call-limit"],n=n.split("/"),C=parseInt(n[0],10),A=parseInt(n[1],10)}),B(this,"handleErrors",(e,t)=>{let a="",r="";if(!p(t.response,"data"))return{data:t.stack,message:t.name};const n=t.response.data;return(null==n?void 0:n.errors)?n.errors.asset?(r=e.data.asset.key,a=n.errors.asset):(a=n.errors,e.data&&(r=e.data.asset?e.data.asset.key+" failed to upload":`${e.method.toUpperCase()} ${e.url}`)):(r="FAILED! "+t,a=t.statusText),{message:r,data:a}})}add(e,t){return new y((a,r)=>{T(this,U).push({target:e,request:t,resolve:a,reject:r}),N||this.process()})}}var U=new WeakMap;async function D(e,t){let a;return I[e.domain]?a=I[e.domain]:(a=new R,I[e.domain]=a),a.add(e,t)}async function J(){let e;try{const t=process.cwd(),a=d.join(t,".shopifysync.json");e=await h.readFile(a,"utf8")}catch(e){throw new Error("The '.shopifysync.json' configuration is missing!")}try{e=JSON.parse(e)}catch(e){throw new Error("Your '.shopifysync.json' file is corrupt. JSON failed to parse")}return e}async function L(e,t,a=null){const r=t.target||null;if(!Array.isArray(e.targets))throw new Error("No targets defined in the '.shopifysync' file");if(r){if(!(a=b(e.targets,{target_name:r})))throw new Error(`Could not find target '${r}'`)}else{const t=$(e.targets,e=>`[${e.target_name}] - '${e.theme_name}' at ${e.domain}.myshopify.com`);if(e.targets.length>1){const r=await j.prompt([{type:"list",name:"target",message:"Select target",default:null,choices:t}]);a=e.targets[w(t,r.target)]}else 1===e.targets.length&&(a=n(e.targets))}const i=Buffer.from(`${a.api_key}:${a.password}`);return a.auth="Basic "+i.toString("base64"),a}function W(e,t={count:0,files:null,log:null,base:/[/\\]\./}){return e.ignore&&e.forceIgnore&&(t.count=e.ignore.length,t.log=e.ignore.join(a`\n\t {whiteBright - }`),t.settings.ignore.push(t.base),t.files=e.ignore),{settings:e,ignored:t}}const G=a`
  {green.bold Shopify Sync} – {bold Commands}
  {gray ---------------------------------------------------------}

  {bold Commands:}
    sync watch [options] – {gray.italic Watch theme folder}
    sync upload [options] [filter] – {gray.italic Upload theme files}
    sync download [options] [filter] – {gray.italic Download theme files}
`;async function M(e,t){let m,y;e._?(m=n(e._),e._=e._.slice(1),e.file=!1):(m=e.resource,e.file=!0);try{"watch"===m?y=await async function(e,t){const n=await J(),i=await L(n,e);e.file||Object.assign(e,n);const s=e.dir||"theme",d=new RegExp("^"+s),{settings:g,ignored:m}=W(e);_.watch(`./${s}/`,{ignored:r(m.files)?m.base:m.files,persistent:!0,ignoreInitial:!0,usePolling:!0,interval:100,binaryInterval:100,cwd:process.cwd()}).on("all",async(e,r)=>{try{const n=r.split(c.sep),m=l(n,o(n,s)+1).join(c.sep);if(r.match(/^\..*$/)||!r.match(d))return F(a`{red Issue in match "/^\..*$/" at: ${r}}"`);if(r.match(/[()]/))return F(a`{red Filename cannot contain parentheses at: "${r}"`);if(p(g,"ignore")&&g.ignore.length>0&&u(g.ignore,r))return F(a`{gray Ignoring} '{gray ${r}}'`);if("change"===e||"add"===e){const e=await h.readFile(r),n=e.toString("base64");await D(i,{method:"put",url:`/admin/themes/${i.theme_id}/assets.json`,data:{asset:{key:m.split(c.sep).join("/"),attachment:n}}}).then(n=>{F(a`{green Uploaded} '{green ${r}}'`),"function"==typeof t&&t.apply({file:c.parse(r),content:e})})}else"unlink"===e&&(await D(i,{method:"delete",url:`/admin/themes/${i.theme_id}/assets.json?asset[key]=${m.split(c.sep).join("/")}`}),F(a`{green Deleted} '{green ${r}}'`))}catch(e){const t=/(?:[{'%]{2}|\/).*?(?:[%'}]{2}|\/)|\(line\s[0-9]+\)/g;let r;if(e.stack)r=e.stack;else{const n=e.data.length>1?"Errors":"Error";r=a`{red.bold ${e.data.length}} {red ${n}} {dim in} {red ${e.message}}`,r+="\n\n",r+=e.data.map((e,r)=>a.bold(r+1)+" "+e.replace(t,e=>"("===e[0]?a.cyan.dim(e):"/"===e[0]?a.magenta(e):a.yellow(e)+".")).join("\n"),r+="\n"}F(r)}});let y=a`  Target: {green ${i.target_name}}\n`+a`   Store: {green https://${i.domain}.myshopify.com}\n`+a`Watching: {green ${s}/**/**}`;r(m.log)||(y+=a`\nIgnoring: {yellow ${m.count}} Files\n`,y+=a`\t {whiteBright -} {yellow ${m.log}}`),F(a.whiteBright.bold("Shopify Sync\n")+v(y,{padding:0,borderColor:"gray",dimBorder:!0,borderStyle:{topLeft:" ",topRight:" ",bottomLeft:" ",bottomRight:" ",horizontal:"-",vertical:" "}}))}(e,t):"upload"===m?y=await async function(e,t){var r;let c=0;const m=await J(),p=await L(m,e);e.file||Object.assign(e,m);const y=e.dir||"theme",f=new RegExp(`^${y}/${n(e._)}`),{settings:w}=W(e),$=n(w._)?f:null;let b=g.sync(y+"/**/*",{nodir:!0});$&&(b=b.filter(e=>$.test(e))),(null==w||null===(r=w.ignore)||void 0===r?void 0:r.length)>0&&(b=b.filter(e=>!u(w.ignore,e)));const j=b.map(e=>{const t=e.split(d.sep),a=l(t,o(t,y)+1).join(d.sep);return{key:a,name:d.basename(a),path:e}}),_=k.create(process.stdout),E=[];return q(!0),O(j,async e=>{await S(100);const r=await h.readFile(e.path);D(p,{method:"put",url:`/admin/themes/${p.theme_id}/assets.json`,data:{asset:{key:e.key,attachment:r.toString("base64")}}}).catch(e=>{E.push(0===E.length?a`{grey.dim ┌──} {redBright Failed} '{red ${e.message}}'`:a`{grey.dim ├──} {redBright Failed} '{red ${e.message}}'`,s(e.data)?e.data.map((t,r)=>e.data.length-1===r?a`{grey.dim │  └──} {dim ${t}}`:a`{grey.dim │  ├──} {dim ${t}}`).join("\n"):!i(e.data)&&a`{yellow.dim.italic ${e.data}}`)}),_(v([a`{magenta    Store}{dim :} {dim.underline ${p.primary_domain}}     `,a`{magenta     File}{dim :} {cyan ${d.basename(e.key)}}`,a`{magenta Progress}{dim :} {cyan ${c+=1}} of {cyan ${j.length}}`,a`{magenta   Output}{dim :} {dim ${y}/}{cyan ${d.dirname(e.key)}}`,a`{magenta   Errors}{dim :} {red ${E.length}}`].join("\n"),{padding:1,borderColor:"gray",dimBorder:!0,borderStyle:"round"}),E.length>0?"\n"+E.join("\n"):""),"function"==typeof t&&t.apply({file:d.parse(e.path),content:r})}).finally(()=>{F(a`Uploaded: {green ${c}} files.`),F(a`Problems: {red ${E.length}}`)})}(e,t):"download"===m?y=await async function(e,t){var r;const o=await J(),l=await L(o,e);e.file||Object.assign(e,o);const c=process.cwd(),g=e.dir||"theme",m=n(e._)?g:null,{settings:p}=W(e),{assets:y}=await D(l,{method:"GET",url:`/admin/themes/${l.theme_id}/assets.json`});let f;m&&(f=y.filter(e=>m.test(e))),f=(null==p||null===(r=p.ignore)||void 0===r?void 0:r.length)>0?y.filter(({key:e})=>!u(p.ignore,e)):f||y,q(!0);let w=0;return O(f,async({key:e})=>{await S(100),D(l,{method:"GET",url:`/admin/themes/${l.theme_id}/assets.json`,params:{"asset[key]":e}}).then(async({asset:{attachment:r,value:n}})=>{const i=r?"base64":"utf8",s=r||n,o=E.Buffer.from(s,i),u=d.join(c,g,e||null);await h.mkdirp(d.join(c,g,d.dirname(e))),await h.writeFile(u,o),"function"==typeof t&&t.apply({file:d.parse(u),content:s}),k(v([a`{magenta    Store}{dim :} {dim.underline ${l.primary_domain}}     `,a`{magenta     File}{dim :} {cyan ${d.basename(e)}}`,a`{magenta Progress}{dim :} {cyan ${w+=1}} of {cyan ${f.length}}`,a`{magenta   Output}{dim :} {dim ${g}/}{cyan ${d.dirname(e)}}`].join("\n"),{padding:1,margin:1,borderColor:"gray",dimBorder:!0,borderStyle:"round"}))}).catch(e=>{problems.push(a`{red Failed} '{red ${e.message}}'`,s(e.data)?e.data.map(e=>a`{red >} {white.dim ${e}}`):!i(e.data)&&a`{yellow.dim.italic ${e.data}}`)})})}(e,t):process.stdout.write(G),y&&process.stdout.write(y)}catch(e){let t=null;e.stack&&(t=e.stack),F(r(t)?e:t,"red")}return y}module.exports=function(e="",r,n){return"object"==typeof e?M(e):e?r.target?M(Object.assign({},{resource:e},{target:"",concurrency:20,dir:"theme",files:[],forceIgnore:!1,ignore:[]},r),n):t(a`{red Error! Please define a {bold theme target}!}`):t(a`{red Error! The {bold resource} option is missing}!`)};
