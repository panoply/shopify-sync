"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("bluebird")),r=e(require("fancy-log")),a=e(require("chalk")),n=e(require("lodash/isNull")),i=e(require("lodash/first")),s=e(require("lodash/isUndefined")),o=e(require("lodash/isArray")),l=e(require("lodash/lastIndexOf")),c=e(require("lodash/drop")),d=e(require("lodash/has")),u=e(require("lodash/filter")),h=e(require("path")),g=e(require("glob")),f=e(require("anymatch")),p=e(require("boxen")),y=e(require("lodash/omit")),m=e(require("fs")),w=e(require("axios")),$=e(require("lodash/indexOf")),b=e(require("lodash/map")),q=e(require("lodash/find")),j=e(require("lodash/join")),k=e(require("chokidar")),v=e(require("lodash/reject"));const E=({api_key:e,password:t,domain:r})=>`https://${e}:${t}@${r}.myshopify.com`,_=(e,t="white",n=!1,i=("object"==typeof e?a[t]([(null==e?void 0:e.message)?e.message+"\n\n\t":"",(null==e?void 0:e.data)?JSON.stringify(e.data.asset?y(e.data.asset,"attachment"):e.data):""].join("")):e))=>n?console.log(i):r(i),S={};function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function x(e,t){var r=t.get(e);if(!r)throw new TypeError("attempted to get private field on non-instance");return r.get?r.get.call(e):r.value}let I=0,A=0,B=40,F=!1;class R{constructor(){T.set(this,{writable:!0,value:[]}),O(this,"process",async()=>{F=!0;do{let e=B-(A+I);e<=0&&(e=0);let r=e*e;r<=.9&&(r=.9);const a=500/r,n=x(this,T).shift();await t.delay(a),this.request(n)}while(x(this,T).length>0);F=!1}),O(this,"request",async({target:e,request:t,reject:r,resolve:a})=>{let n,i=null;I+=1;try{const r=Object.assign({},t,{url:`${E(e)}${t.url}`});i=await w(r)}catch(n){return"Too Many Requests"===n.statusText?(_("Exceeded Shopify API limit, will retry...","yellow"),x(this,T).unshift({target:e,request:t,resolve:a,reject:r})):r(this.handleErrors(t,n))}if(I-=1,await a(i.data),i.data.errors)return r(i.data.errors);n=i.headers["x-shopify-shop-api-call-limit"],n=n.split("/"),A=parseInt(n[0],10),B=parseInt(n[1],10)}),O(this,"handleErrors",(e,t)=>{let r="",a="";if(!d(t.response,"data"))return{data:t.stack,message:t.name};const n=t.response.data;return(null==n?void 0:n.errors)?n.errors.asset?(a=e.data.asset.key,r=n.errors.asset):(r=n.errors,e.data&&(a=e.data.asset?`${e.data.asset.key} failed to upload`:`${e.method.toUpperCase()} ${e.url}`)):(a=`FAILED! ${t}`,r=t.statusText),{message:a,data:r}})}add(e,r){return new t((t,a)=>{x(this,T).push({target:e,request:r,resolve:t,reject:a}),F||this.process()})}}var T=new WeakMap;async function C(e,t){let r;S[e.domain]?r=S[e.domain]:(r=new R,S[e.domain]=r),await r.add(e,t)}const P=t.promisifyAll(require("fs"));async function U(){let e;try{const t=process.cwd();let r=h.join(t,".shopifysync.json");r||(r=h.join(t,".shopifysync")),e=await P.readFileAsync(r,"utf8")}catch(e){throw new Error("The '.shopifysync.json' configuration is missing!")}try{e=JSON.parse(e)}catch(e){throw new Error("Your '.shopifysync.json' file is corrupt. JSON failed to parse")}return e}const D=t.promisifyAll(require("inquirer"));async function L(e,t,r=null){const a=t.target||null;if(!o(e.targets))throw new Error("No targets defined in the '.shopifysync' file");if(a){if(!(r=q(e.targets,{target_name:a})))throw new Error(`Could not find target '${a}'`)}else{const t=b(e.targets,e=>`[${e.target_name}] - '${e.theme_name}' at ${e.domain}.myshopify.com`);if(e.targets.length>1){const a=await D.prompt([{type:"list",name:"target",message:"Select target",default:null,choices:t}]);r=e.targets[$(t,a.target)]}else 1===e.targets.length&&(r=i(e.targets))}const n=Buffer.from(`${r.api_key}:${r.password}`);return r.auth=`Basic ${n.toString("base64")}`,r}function N(e,t={base:/[/\\]\./,count:0,files:null,log:null}){return e.ignore&&e.forceIgnore&&(t.count=e.ignore.length,t.log=j(e.ignore,a`\n\t {whiteBright - }`),e.ignore.push(t.base),t.files=e.ignore),{settings:e,ignored:t}}t.promisifyAll(m),m.mkdirp=require("mkdirp"),t.promisifyAll(m);const J=a`
  {green.bold Shopify Sync} – {bold Commands}
  {gray ---------------------------------------------------------}

  {bold Commands:}
    sync watch [options] – {gray.italic Watch theme folder}
    sync upload [options] [filter] – {gray.italic Upload theme files}
    sync download [options] [filter] – {gray.italic Download theme files}

  {bold Options:}
    --target=[target name] – {gray.italic Explicitly select theme target}
    --filter=[filename] – {gray.italic Only transfer files matching specified filter}
`;async function W(e,r){let y,$;try{e._?(y=i(e._),e._=e._.slice(1),e.file=!1):(y=e.resource,e.file=!0),"watch"===y?$=await async function(e,t){const r=await U(),i=await L(r,e);e.file||Object.assign(e,r);const s=e.dir||"theme",o=new RegExp(`^${s}`),{settings:u,ignored:g}=N(e);k.watch(`./${s}/`,{ignored:n(g.files)?g.base:g.files,persistent:!0,ignoreInitial:!0,usePolling:!0,interval:100,binaryInterval:100,cwd:process.cwd()}).on("all",async(e,r)=>{try{const n=r.split(h.sep),g=c(n,l(n,s)+1).join(h.sep);if(r.match(/^\..*$/)||!r.match(o))return _(a`{red Issue in match "/^\..*$/" at: ${r}}"`);if(r.match(/[()]/))return _(a`{red Filename cannot contain parentheses at: "${r}"`);if(d(u,"ignore")&&u.ignore.length>0&&f(u.ignore,r))return _(a`{gray Ignoring} '{gray ${r}}'`);if("change"===e||"add"===e){const e=await m.readFileAsync(r),n=e.toString("base64");await C(i,{method:"put",url:`/admin/themes/${i.theme_id}/assets.json`,data:{asset:{key:g.split(h.sep).join("/"),attachment:n}}}).then(n=>{_(a`{green Uploaded} '{green ${r}}'`),"function"==typeof t&&t.apply({file:h.parse(r),content:e})})}else"unlink"===e&&(await C(i,{method:"delete",url:`/admin/themes/${i.theme_id}/assets.json?asset[key]=${g.split(h.sep).join("/")}`}),_(a`{green Deleted} '{green ${r}}'`))}catch(e){const t=e.stack?e.stack:a`{red.bold ${e.data.length}} {red ${e.data.length>1?"Errors":"Error"}} {dim in} {red ${e.message}}
        \n  {red ${e.data.map((e,t)=>a`{bold ${t+1}}. `+e.replace(/(?:[{'%]{2}|\/).*?(?:[%'}]{2}|\/)|\(line\s[0-9]+\)/g,e=>"("===e[0]?a`{cyan.dim ${e}}`:"/"===e[0]?a`{magenta ${e}}`:a`{yellow ${e}}`+".")).join("\n  ")}}\n`;_(t)}});let y=a`  Target: {green ${i.target_name}}\n`+a`   Store: {green https://${i.domain}.myshopify.com}\n`+a`Watching: {green ${s}/**/**}`;n(g.log)||(y+=a`\nIgnoring: {yellow ${g.count}} Files\n`,y+=a`\t {whiteBright -} {yellow ${g.log}}`),await _(a.whiteBright.bold("Shopify Sync\n")+p(y,{padding:0,borderColor:"gray",dimBorder:!0,borderStyle:{topLeft:" ",topRight:" ",bottomLeft:" ",bottomRight:" ",horizontal:"-",vertical:" "}}))}(e,r):"upload"===y?$=await async function(e,r){let n=0,y=0;const w=await U(),$=await L(w,e);e.file||Object.assign(e,w);const b=e.dir||"theme",q=new RegExp(`^${b}/${i(e._)}`),{settings:j}=N(e),k=i(j._)?q:null;let v=g.sync(`${b}/**/*`,{nodir:!0});k&&(v=u(v,e=>k.test(e))),d(j,"ignore")&&j.ignore.length>0&&(v=v.filter(e=>!f(j.ignore,e)));const E=v.map(e=>{const t=e.split(h.sep),r=c(t,l(t,b)+1).join(h.sep);return{key:r,name:h.basename(r),path:e}});return t.each(E,async e=>{const t=await m.readFileAsync(e.path);await C($,{method:"put",url:`/admin/themes/${$.theme_id}/assets.json`,data:{asset:{key:e.key,attachment:t.toString("base64")}}}).then(()=>{n+=1,_(a`{green Uploaded} '{green ${e.key}}'`),"function"==typeof r&&r.apply({file:h.parse(e.path),content:t})}).catch(e=>{y+=1,_(a`{red Failed} '{red ${e.message}}'`),o(e.data)?e.data.forEach(e=>_(a`{red >} {white.dim ${e}}`)):!s(e.data)&&_(a`{yellow.dim.italic ${e.data}}`)})},{concurrency:j.concurrency}).finally(()=>{const e=a`Uploaded: {green ${n}} files.\n`+a`Problems: {red ${y}}`;return _(p(e,{padding:0,borderColor:"gray",dimBorder:!0,borderStyle:{topLeft:" ",topRight:" ",bottomLeft:" ",bottomRight:" ",horizontal:"-",vertical:" "}}),"white",!0)})}(e,r):"download"===y?$=await async function(e,r){let n=0;const s=await U(),o=await L(s,e);e.file||Object.assign(e,s);const l=process.cwd(),c=e.dir||"theme",g=i(e._)?c:null,{settings:f}=N(e);try{const e=`${E(o)}/admin/themes/${o.theme_id}/assets.json`,{data:i}=await w.get(e);let{assets:s}=i;return d(s,"ignore")&&f.ignore.length>0&&(s=v(s,e=>f.ignore.includes(e))),g&&(s=u(s,e=>g.test(e.key))),t.each(s,(async function({attachment:e,value:t,key:i}){let s;e?s=Buffer.from(e,"base64"):t&&(s=Buffer.from(t,"utf8"));const o=h.join(l,c,i||null);await m.mkdirp(h.join(l,c,h.dirname(i))),await m.writeFileAsync(o,s),"function"==typeof r&&r.apply({file:h.parse(o),content:e}),_(a`{green Downloaded} '{green ${i}} to {green ${c}}'`),n+=1}),{concurrency:f.concurrency})}catch(e){console.error(e)}return`Downloaded ${n} files.`}(e,r):process.stdout.write(J),$&&process.stdout.write($)}catch(e){let t=null;e.stack&&(t=e.stack),_(n(t)?e:t,"red")}return $}global.Promise=t,module.exports=function(e="",t,n){return"object"==typeof e?W(e):e?t.target?W(Object.assign({},{resource:e},{target:"",concurrency:20,dir:"theme",files:[],forceIgnore:!1,ignore:[]},t),n):r(a`{red Error! Please define a {bold theme target}!}`):r(a`{red Error! The {bold resource} option is missing}!`)};
