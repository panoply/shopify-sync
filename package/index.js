"use strict";var e=require("fancy-log"),t=require("chalk"),a=require("lodash/isNull"),r=require("lodash/first"),n=require("lodash/isUndefined"),i=require("lodash/isArray"),s=require("lodash/lastIndexOf"),l=require("lodash/drop"),o=require("path"),d=require("glob"),u=require("anymatch"),f=require("lodash/omit"),c=require("fs-extra"),g=require("lodash/has"),h=require("bluebird"),m=require("axios"),y=require("lodash/indexOf"),p=require("lodash/map"),w=require("lodash/find"),$=require("inquirer"),b=require("console-clear"),j=require("log-update"),q=require("boxen"),k=require("chokidar"),v=require("buffer");function _(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var E=_(e),S=_(t),O=_(a),x=_(r),F=_(n),I=_(i),B=_(s),T=_(l),P=_(o),C=_(d),A=_(u),N=_(f),R=_(g),U=_(h),D=_(m),J=_(y),L=_(p),W=_(w),G=_($),M=_(b),z=_(j),Y=_(q),H=_(k);const K=e=>new Promise((t=>setTimeout(t,e))),Q=async(e,t)=>{for(let a=0;a<e.length;a++)await t(e[a],a,e)},V=({api_key:e,password:t,domain:a})=>`https://${e}:${t}@${a}.myshopify.com`,X=(e,t="white",a=!1,r=("object"==typeof e?S.default[t]([null!=e&&e.message?e.message+"\n\n\t":"",null!=e&&e.data?JSON.stringify(e.data.asset?N.default(e.data.asset,"attachment"):e.data):""].join("")):e))=>a?console.log(r):E.default(r),Z={};function ee(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function te(e,t){return function(e,t){if(t.get)return t.get.call(e);return t.value}(e,function(e,t,a){if(!t.has(e))throw new TypeError("attempted to "+a+" private field on non-instance");return t.get(e)}(e,t,"get"))}let ae=0,re=0,ne=40,ie=!1;var se=new WeakMap;class le{constructor(){se.set(this,{writable:!0,value:[]}),ee(this,"process",(async()=>{ie=!0;do{let e=ne-(re+ae);e<=0&&(e=0);let t=e*e;t<=.9&&(t=.9);const a=500/t,r=te(this,se).shift();await U.default.delay(a),this.request(r)}while(te(this,se).length>0);ie=!1})),ee(this,"request",(async({target:e,request:t,reject:a,resolve:r})=>{let n,i=null;ae+=1;try{const a=Object.assign({},t,{url:`${V(e)}${t.url}`});i=await D.default(a)}catch(n){return"Too Many Requests"===n.statusText?(X("Exceeded Shopify API limit, will retry...","yellow"),te(this,se).unshift({target:e,request:t,resolve:r,reject:a})):a(this.handleErrors(t,n))}if(ae-=1,await r(i.data),i.data.errors)return a(i.data.errors);n=i.headers["x-shopify-shop-api-call-limit"],n=n.split("/"),re=parseInt(n[0],10),ne=parseInt(n[1],10)})),ee(this,"handleErrors",((e,t)=>{let a="",r="";if(!R.default(t.response,"data"))return{data:t.stack,message:t.name};const n=t.response.data;return null!=n&&n.errors?n.errors.asset?(r=e.data.asset.key,a=n.errors.asset):(a=n.errors,e.data&&(r=e.data.asset?`${e.data.asset.key} failed to upload`:`${e.method.toUpperCase()} ${e.url}`)):(r=`FAILED! ${t}`,a=t.statusText),{message:r,data:a}}))}add(e,t){return new U.default(((a,r)=>{te(this,se).push({target:e,request:t,resolve:a,reject:r}),ie||this.process()}))}}async function oe(e,t){let a;return Z[e.domain]?a=Z[e.domain]:(a=new le,Z[e.domain]=a),a.add(e,t)}async function de(){let e;try{const t=process.cwd(),a=o.join(t,".shopifysync.json");e=await c.readFile(a,"utf8")}catch(e){throw new Error("The '.shopifysync.json' configuration is missing!")}try{e=JSON.parse(e)}catch(e){throw new Error("Your '.shopifysync.json' file is corrupt. JSON failed to parse")}return e}async function ue(e,t,a=null){const r=t.target||null;if(!Array.isArray(e.targets))throw new Error("No targets defined in the '.shopifysync' file");if(r){if(!(a=W.default(e.targets,{target_name:r})))throw new Error(`Could not find target '${r}'`)}else{const t=L.default(e.targets,(e=>`[${e.target_name}] - '${e.theme_name}' at ${e.domain}.myshopify.com`));if(e.targets.length>1){const r=await G.default.prompt([{type:"list",name:"target",message:"Select target",default:null,choices:t}]);a=e.targets[J.default(t,r.target)]}else 1===e.targets.length&&(a=x.default(e.targets))}const n=Buffer.from(`${a.api_key}:${a.password}`);return a.auth=`Basic ${n.toString("base64")}`,a}function fe(e,t={count:0,files:null,log:null,base:/[/\\]\./}){return e.ignore&&e.forceIgnore&&(t.count=e.ignore.length,t.log=e.ignore.join(S.default`\n\t {whiteBright - }`),e.ignore.push(t.base),t.files=e.ignore),{settings:e,ignored:t}}const ce=S.default`
  {green.bold Shopify Sync} – {bold Commands}
  {gray ---------------------------------------------------------}

  {bold Commands:}
    sync watch [options] – {gray.italic Watch theme folder}
    sync upload [options] [filter] – {gray.italic Upload theme files}
    sync download [options] [filter] – {gray.italic Download theme files}
`;async function ge(e,t){let a,r;e._?(a=x.default(e._),e._=e._.slice(1),e.file=!1):(a=e.resource,e.file=!0);try{"watch"===a?r=await async function(e,t){const a=await de(),r=await ue(a,e);e.file||Object.assign(e,a);const n=e.dir||"theme",i=new RegExp(`^${n}`),{settings:s,ignored:l}=fe(e);H.default.watch(`./${n}/`,{ignored:O.default(l.files)?l.base:l.files,persistent:!0,ignoreInitial:!0,usePolling:!0,interval:100,binaryInterval:100,cwd:process.cwd()}).on("all",(async(e,a)=>{try{const l=a.split(P.default.sep),o=T.default(l,B.default(l,n)+1).join(P.default.sep);if(a.match(/^\..*$/)||!a.match(i))return X(S.default`{red Issue in match "/^\..*$/" at: ${a}}"`);if(a.match(/[()]/))return X(S.default`{red Filename cannot contain parentheses at: "${a}"`);if(R.default(s,"ignore")&&s.ignore.length>0&&A.default(s.ignore,a))return X(S.default`{gray Ignoring} '{gray ${a}}'`);if("change"===e||"add"===e){const e=await c.readFile(a),n=e.toString("base64");try{await oe(r,{method:"put",url:`/admin/themes/${r.theme_id}/assets.json`,data:{asset:{key:o.split(P.default.sep).join("/"),attachment:n}}}),X(S.default`{green Uploaded} '{green ${a}}'`),"function"==typeof t&&t.apply({file:P.default.parse(a),content:e})}catch(e){throw X(e)}}else if("unlink"===e)try{await oe(r,{method:"delete",url:`/admin/themes/${r.theme_id}/assets.json?asset[key]=${o.split(P.default.sep).join("/")}`}),X(S.default`{green Deleted} '{green ${a}}'`)}catch(e){throw X(e)}}catch(e){let t;if(e.stack)t=e.stack;else{const a=e.data.length>1?"Errors":"Error";t=S.default`{red.bold ${e.data.length}} {red ${a}} {dim in} {red ${e.message}}`,t+="\n\n",t+=e,t+="\n"}throw X(t)}}));let o=S.default`  Target: {green ${r.target_name}}\n`+S.default`   Store: {green https://${r.domain}.myshopify.com}\n`+S.default`Watching: {green ${n}/**/**}`;O.default(l.log)||(o+=S.default`\nIgnoring: {yellow ${l.count}} Files\n`,o+=S.default`\t {whiteBright -} {yellow ${l.log}}`),X(S.default.whiteBright.bold("Shopify Sync\n")+Y.default(o,{padding:0,borderColor:"gray",dimBorder:!0,borderStyle:{topLeft:" ",topRight:" ",bottomLeft:" ",bottomRight:" ",horizontal:"-",vertical:" "}}))}(e,t):"upload"===a?r=await async function(e,t){var a;let r=0;const n=await de(),i=await ue(n,e);e.file||Object.assign(e,n);const s=e.dir||"theme",l=new RegExp(`^${s}/${x.default(e._)}`),{settings:d}=fe(e),u=x.default(d._)?l:null;let f=C.default.sync(`${s}/**/*`,{nodir:!0});u&&(f=f.filter((e=>u.test(e)))),(null==d||null===(a=d.ignore)||void 0===a?void 0:a.length)>0&&(f=f.filter((e=>!A.default(d.ignore,e))));const g=f.map((e=>{const t=e.split(o.sep),a=T.default(t,B.default(t,s)+1).join(o.sep);return{key:a,name:o.basename(a),path:e}})),h=z.default.create(process.stdout),m=[];return M.default(!0),Q(g,(async e=>{await K(100);const a=await c.readFile(e.path);oe(i,{method:"put",url:`/admin/themes/${i.theme_id}/assets.json`,data:{asset:{key:e.key,attachment:a.toString("base64")}}}).catch((e=>{m.push(0===m.length?S.default`{grey.dim ┌──} {redBright Failed} '{red ${e.message}}'`:S.default`{grey.dim ├──} {redBright Failed} '{red ${e.message}}'`,I.default(e.data)?e.data.map(((t,a)=>e.data.length-1===a?S.default`{grey.dim │  └──} {dim ${t}}`:S.default`{grey.dim │  ├──} {dim ${t}}`)).join("\n"):!F.default(e.data)&&S.default`{yellow.dim.italic ${e.data}}`)})),h(Y.default([S.default`{magenta    Store}{dim :} {dim.underline ${i.primary_domain}}     `,S.default`{magenta     File}{dim :} {cyan ${o.basename(e.key)}}`,S.default`{magenta Progress}{dim :} {cyan ${r+=1}} of {cyan ${g.length}}`,S.default`{magenta   Output}{dim :} {dim ${s}/}{cyan ${o.dirname(e.key)}}`,S.default`{magenta   Errors}{dim :} {red ${m.length}}`].join("\n"),{padding:1,borderColor:"gray",dimBorder:!0,borderStyle:"round"}),m.length>0?`\n${m.join("\n")}`:""),"function"==typeof t&&t.apply({file:o.parse(e.path),content:a})})).finally((()=>{X(S.default`Uploaded: {green ${r}} files.`),X(S.default`Problems: {red ${m.length}}`)}))}(e,t):"download"===a?r=await async function(e,t){var a;const r=await de(),n=await ue(r,e);e.file||Object.assign(e,r);const i=process.cwd(),s=e.dir||"theme",l=x.default(e._)?s:null,{settings:d}=fe(e),{assets:u}=await oe(n,{method:"GET",url:`/admin/themes/${n.theme_id}/assets.json`});let f;l&&(f=u.filter((e=>l.test(e)))),f=(null==d||null===(a=d.ignore)||void 0===a?void 0:a.length)>0?u.filter((({key:e})=>!A.default(d.ignore,e))):f||u,M.default(!0);let g=0;return Q(f,(async({key:e})=>{await K(100),oe(n,{method:"GET",url:`/admin/themes/${n.theme_id}/assets.json`,params:{"asset[key]":e}}).then((async({asset:{attachment:a,value:r}})=>{const l=a?"base64":"utf8",d=a||r,u=v.Buffer.from(d,l),h=o.join(i,s,e||null);await c.mkdirp(o.join(i,s,o.dirname(e))),await c.writeFile(h,u),"function"==typeof t&&t.apply({file:o.parse(h),content:d}),z.default(Y.default([S.default`{magenta    Store}{dim :} {dim.underline ${n.primary_domain}}     `,S.default`{magenta     File}{dim :} {cyan ${o.basename(e)}}`,S.default`{magenta Progress}{dim :} {cyan ${g+=1}} of {cyan ${f.length}}`,S.default`{magenta   Output}{dim :} {dim ${s}/}{cyan ${o.dirname(e)}}`].join("\n"),{padding:1,margin:1,borderColor:"gray",dimBorder:!0,borderStyle:"round"}))})).catch((e=>{problems.push(S.default`{red Failed} '{red ${e.message}}'`,I.default(e.data)?e.data.map((e=>S.default`{red >} {white.dim ${e}}`)):!F.default(e.data)&&S.default`{yellow.dim.italic ${e.data}}`)}))}))}(e,t):process.stdout.write(ce),void 0!==r&&process.stdout.write(r)}catch(e){let t=null;e.stack&&(t=e.stack),X(O.default(t)?e:t,"red")}return r}module.exports=function(e="",t,a){return"object"==typeof e?ge(e):e?t.target?ge(Object.assign({resource:e,target:"",concurrency:20,dir:"theme",files:[],forceIgnore:!1,ignore:[]},t),a):E.default(S.default`{red Error! Please define a {bold theme target}!}`):E.default(S.default`{red Error! The {bold resource} option is missing}!`)};
